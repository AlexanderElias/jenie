
<script>

const Descriptors = function (data) {
    const descriptors = {};

    for (const name in data) {
        if (data.hasOwnProperty(name)) {
            descriptors[name] = Object.getOwnPropertyDescriptor(data, name);
        }
    }

    return descriptors;
};

const $extends = function (parent, child) {

    const parentDescriptors = Descriptors(parent);
    const childPrototypeDescriptors = Descriptors(child.prototype);

    // Object.setPrototypeOf(child, parent);
    // Object.setPrototypeOf(child.prototype, parent.prototype);

    child.prototype = Object.create(parent.prototype);
    Object.defineProperties(child, parentDescriptors);
    Object.defineProperties(child.prototype, childPrototypeDescriptors);

    const prototype = child.prototype;

    const $super = function () {
        const { constructor } = Object.getPrototypeOf(prototype);
        return this.__self = window.Reflect.construct(constructor, arguments, this.constructor);
    };

    Object.defineProperty(child.prototype, '$super', { enumerable: false, writable: true, value: $super });
    Object.defineProperty(child.prototype, 'constructor', { enumerable: false, writable: true, value: child });

    return child;
};

const $construct = function (data) {
    if (!data || typeof data === 'function') return data;

    const { constructor } = data;
    const descriptors = Descriptors(data);

    const Construct = function Construct () {
        constructor.apply(this, arguments);
        return Object.assign(this.__self, this);
    };

    Object.defineProperties(Construct.prototype, descriptors);
    Object.defineProperty(Construct.prototype, 'constructor', { enumerable: false, writable: true, value: Construct });

    return Construct;
};

const $class = function (parent, child) {
    child = child || parent;
    parent = parent === child ? undefined : parent;

    if (child) child = $construct(child);
    if (parent) parent = $construct(parent);

    return child && parent ? $extends(parent, child) : child;
};

const Thing = $class(HTMLElement, {
// const Thing = $class({

    get observered () {
        return [ 'one' ];
    },

    constructor () {
        this.$super();
        this.message = 'test';
    },

    method () {
        console.log(this.message);
    },

});

// const t = new Thing('hello wolrds');
window.customElements.define('o-thing', Thing);
const t = document.createElement('o-thing');
t.method();
console.log('t instanceof Thing', t instanceof Thing);
console.log('t instanceof HTMLElement', t instanceof HTMLElement);

// const OElement = extend(HTMLElement, class OElement {
//     constructor() {
//         console.log('OElement');
//     }
// });

const OElement = $extends(HTMLElement, function OElement () {
    console.log('OElement');
    return this.$super();
    // return window.Reflect.construct(HTMLElement, [], this.constructor);
});

OElement.prototype.connectedCallback = function () {
    this.innerHTML = 'hello world';
    if (this.attached) {
        this.attached.apply(this, arguments);
    }
};

OElement.prototype.attributeChangedCallback = function () { console.log(arguments); }
window.customElements.define('my-element', OElement);

// const MyElement = $class(OElement, function (s) {
//     console.log('MyElement');
//     return this.$super();
// });
// // const MyElement = $class(class MyElement extends OElement {
// //     constructor () {
// //         super();
// //         console.log('MyElement');
// //     }
// // });
// MyElement.observedAttributes = [ 'three' ];
// // MyElement.prototype.observedAttributes = [ 'three' ];
//
// // Object.defineProperty(OElement, 'observedAttributes', {
// // Object.defineProperty(OElement.prototype, 'observedAttributes', {
// //     get: function () {
// //         return this.observered || [ 'two' ];
// //     }
// // });
// MyElement.prototype.attached = function () {
//     this.innerHTML = 'hello world';
// }
// window.customElements.define('my-element', MyElement);

setTimeout(function () {
    const myElement = document.createElement('my-element');
    console.log(myElement instanceof HTMLElement)
    console.log(myElement instanceof OElement);
    // console.log(myElement instanceof MyElement)
    myElement.setAttribute('one', 1);
    myElement.setAttribute('two', 2);
    myElement.setAttribute('three', 3);
    document.body.appendChild(myElement);
}, 500);

</script>
